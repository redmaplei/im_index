<html class="standard">

<head>
    <meta charset="utf-8">
    <title>客服聊天</title>
    <link href="../css/im_index/boss/c.css" type="text/css" rel="stylesheet">
    <link href="../css/im_index/boss/main.css" type="text/css" rel="stylesheet">
    <link href="../css/im_index/boss/prop-mall.css" type="text/css" rel="stylesheet">
    <link href="../css/framework/layui.css" type="text/css" rel="stylesheet">



</head>

<body>

    <div id="wrap">
        <div id="header">
            <div class="top">

                <ul class="layui-nav">
                    <div class="top-in">

                        <li class="layui-nav-item home">
                            <a href="../html/home.html" class="active">首页</a>
                        </li>

                        <li class="layui-nav-item message">
                            <a href="../html/chat.html" style="color:#22d7c6">消息<span class="layui-badge">9</span></a>
                        </li>

                        <li class="layui-nav-item person; width:auto;">

                            <a href="../html/person.html">
                                <span>
                                    周星驰
                                </span>
                                &nbsp;&nbsp;<img src="/img/e.jpg" class="layui-nav-img"></a>
                        </li>


                </ul>

            </div>
        </div>

        <div id="main">
            <div id="container">
                <div class="chat-container page-container">
                    <div class="chat-wrap">
                        <div>
                            <!-- <div class="data-tips" style="display: none;">
                                <div class="page-loading">
                                    <div class="spinner"><span class="loader-round"></span>
                                        <p>正在加载中...</p>
                                    </div>
                                </div>
                            </div> -->
                            <div id="chat-user" class="chat-user">
                                <div class="article">30天内联系人</div>

                                <div id="user-list" class="user-list" style="background-color:	#FAFAFA">

                                    <ul id="general-list" v-for="user in userList">

                                        <li id="user" class="" @click="openWindow($event, user)">
                                            <div class="figure">
                                                <img :src="user.avatarUrl">
                                            </div>
                                            <div class="text">
                                                <div class="title"><span class="time">02:51</span>
                                                    <span class="name"> {{user.serviceName}} </span>
                                                    <span class="name" style="font-size:12.5px;color:gray">{{user.shop
                                                        }}</span>
                                                </div>
                                                <span class="notice-badge">{{ user.count }}</span>
                                            </div>
                                        </li>
                                    </ul>




                                </div>
                            </div>
                        </div>



                        <div id="chat-record" class="chat-record  ">
                            <!---->



                            <div id="chatmain" class="chat-left " style="display: none ; ">
                                <div class="article">
                                    <span> {{serviceName}} </span>
                                    <span> {{status}} </span>
                                </div>
                                <div class="chat-position-bar" style=" ">
                                    <a href="/job_detail/1ff627012a85a9231Hd52dq5FFA~.html" target="_blank">
                                        <!-- <span>京东</span>  -->
                                        <span class="bar-position-name"> {{shop}} </span>
                                    </a>
                                </div>

                                <div id="chat" class="chat-message" style=" ">
                                    <ul id="im-list" class="im-list">
                                        <li style="margin-bottom: -25px;">
                                            <div class="message-text">
                                                <div class="figure">
                                                    <img src="/img/a.jpg">
                                                </div>
                                                <div class="text">
                                                    <!---->
                                                    <div><i class=" "></i>
                                                        我想要一份您的附件简历到我的邮箱，您是否同意箱，您是否同意箱，您是否同意箱，您是否同意

                                                    </div>
                                                </div>
                                        </li>
                                        <li class=" item-time "><span class=" time">03-28 14:38</span></li>
                                        <li class=" " style="margin-bottom: -25px;">
                                            <div class=" " style="float:right;">
                                                <div class="text" style=""><i class=" "></i>
                                                    <p>
                                                        <span style="">
                                                            希望这间呢？
                                                            希望这间呢？1
                                                            希望这间呢？23
                                                            希望这间呢？4
                                                            希望这间呢？5353
                                                            希望这间呢？345s
                                                            希望这间呢？

                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="figure">
                                                    <!---->
                                                    <img src="/img/c.jpg" class="float:right">

                                                </div>
                                            </div>
                                        </li>
                                        <li class=" item-time"><span class=" time">03-28 14:38</span></li>

                                        <li class=" " style="margin-bottom: -25px;">
                                            <div class=" " style="float:right;">
                                                <div class="text"><i class=" "></i>
                                                    <p>
                                                        <span>
                                                            希望这间呢？
                                                            希望这间呢？1
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="figure">
                                                    <!---->
                                                    <img src="/img/c.jpg" class="float:right">

                                                </div>
                                            </div>
                                        </li>
                                        <li class=" item-time"><span class=" time">03-28 14:38</span></li>

                                        <li class=" " style="margin-bottom: -25px;">
                                            <div class=" " style="float:right;">
                                                <div class="text"><i class=" "></i>
                                                    <p>
                                                        <span>
                                                            希望这间呢？
                                                            希望这间呢？1
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="figure">
                                                    <!---->
                                                    <img src="/img/c.jpg" class="float:right">

                                                </div>
                                            </div>
                                        </li>
                                        <li class=" item-time"><span class=" time">03-28 14:38</span></li>

                                        <li class=" " style="margin-bottom: -25px;">
                                            <div class=" " style="float:right;">
                                                <div class="text"><i class=" "></i>
                                                    <p>
                                                        <span>
                                                            希望这间呢？
                                                            希望这间呢？1
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="figure">
                                                    <!---->
                                                    <img src="/img/c.jpg" class="float:right">

                                                </div>
                                            </div>
                                        </li>
                                        <li class=" item-time"><span class=" time">03-28 14:38</span></li>

                                        <li class=" " style="margin-bottom: -25px;">
                                            <div class=" " style="float:right;">
                                                <div class="text"><i class=" "></i>
                                                    <p>
                                                        <span>
                                                            希望这间呢？
                                                            希望这间呢？1
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="figure">
                                                    <!---->
                                                    <img src="/img/c.jpg" class="float:right">

                                                </div>
                                            </div>
                                        </li>
                                        <li class=" item-time"><span class=" time">03-28 14:38</span></li>
                                    </ul>
                                </div>
                                <div class="chat-im chat-editor" style="">


                                    <div class="control  chat-controls" style="height: 30;">
                                        <a href="javascript:;" class="btn-emotion"><span>表情</span></a>
                                    </div>

                                    <!-- <div id="input"  contenteditable="true" class="chat-input" style="height:  60;">
                                            <textarea style="line-height: 1;width: 100%;height: 100%;">

                                            </textarea>

                                        </div> -->
                                    <div style="width:100%;height:  56;">
                                        <textarea id="sendText" style="line-height: 1;width: 100%;height: 100%; resize: none;
                                            border: 1px solid white; " >{{sendText}}</textarea>
                                    </div>
                                    <div class="send" style="margin-top:8px;">
                                        <button class="layui-btn layui-btn-sm" style=" float:right;" onclick="sendMsgToServer()">发送</button>
                                    </div>





                                </div>

                            </div>
                            <div id="tips" class="tips" style="display: ;">
                                <p><b>Tips：</b>与您进行过沟通的客服都会在左侧列表中显示</p>
                                <!-- <div class="welcome-tips">
                                        
                                    </div> -->
                            </div>
                            <!---->

                            <!-- <div id="test">
                                    =====
                                    <button @click=openWindow()>
                                        sdf
                                    </button>
                                </div> -->


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- <script type="text/javascript" src="https://static.zhipin.com/library/js/lib/jquery-1.12.2.min.js"></script>
        <script src="https://static.zhipin.com/library/js/lib/mqtt.js"></script>
        <script src="https://static.zhipin.com/zhipin/v149/web/geek/chat/vendor.js"></script>
        <script src="https://static.zhipin.com/zhipin/v149/web/geek/chat/app.js"></script>
        <script type="text/javascript" src="https://static.zhipin.com/zhipin/v149/web/geek/js/propMall.js"></script>
    <input type="hidden" id="page_key_name" value="cpc_chat"> -->


    <script src="../js/framework/vue.js"></script>
    <script src="../js/framework/layui.js"></script>
    <script src="../js/framework/jquery-3.2.1.min.js"></script>
    <script src="../js/framework/stomp.min.js"></script>
    <script src="../js/framework/sockjs.min.js"></script>


    <script>
        //   var articleVue = new Vue({
        //   el: '#article',
        //   data: {
        //       articles: [],
        //   },
        //   methods: {
        //       jumpreadmd: function (blogtitle) {

        //           // 拿到的字符串前面有空格，不懂
        //           // blogtitle = blogtitle.replace(/(^\s*)/g, "");   // 去除前面的空格

        //           localStorage.setItem("blogtitle", blogtitle);
        //           window.location.href = "/html/read.html";

        //       }
        //   }
        // });

        // 数据加载
        // 获取聊天列表
        //     $(function () {
        //        $.ajax({

        //           url:config.url.get_article_new,
        //           type:'GET',
        //           contentType:'application/json; charset=UTF-8',
        //           success:function (userList) {
        //               chatmain.userList = userList.data;
        //           },
        //           error: function() {
        //               console.log("服务器获取失败");
        //           }
        //       });

        //   });

        var chatmain = new Vue({
            el: '#user-list',
            data: {
                userList: [{
                        serviceId: 123,
                        avatarUrl: "../img/a.jpg",
                        serviceName: "黄丽莉1",
                        shop: "京东1",
                        count: 10
                    },
                    {
                        serviceId: 13,
                        avatarUrl: "../img/b.jpg",
                        serviceName: "田",
                        shop: "盛大1",
                        count: 0
                    }

                ]
            },
            methods: {
                openWindow: function (event, user) {
                    $("#tips").css("display", "none")
                    $("#chatmain").css("display", "")
                    // 获取点击对象      
                    var el = event.currentTarget;
                    // $(el).css("background","#E0E0E0") 

                    // console.log(user.serviceId)
                    chatmain.init(user);
                    // console.log(chatmain.status);

                }



            }
        });

        // 聊天窗口
        var chatmain = new Vue({
            el: '#chatmain',
            data: {
                serviceName: "",
                status: "在线",
                shop: "",
                sendText: "",
                serviceId: "",
            },
            methods: {

                init: function (user) {
                    this.serviceName = user.serviceName;
                    this.shop = user.shop;
                    this.serviceId = user.serviceId;
                    getWebSocket();
                    // closeWebSocket();

                },

                webSocket: function (jsonStr) {



                }

            }
        });

        var chat = new Vue({
            el: '#chat',
            data: {
                message: [],
            },
            methods: {
                webSocket: function (jsonStr) {



                }
            }
        });





        // 聊天模块
        function getWebSocket() {
            /**
             * WebSocket客户端 PS：URL开头表示WebSocket协议 中间是域名端口 结尾是服务端映射地址
             */
            var webSocket = new WebSocket( /*[[${webSocketUrl}]]*/ 'ws://localhost:8080/chat');
            /**
             * 当服务端打开连接
             */
            webSocket.onopen = function (event) {
                console.log('WebSocket打开连接');
                
            };

            /**
             * 当服务端发来消息：1.广播消息 2.更新在线人数
             */
            webSocket.onmessage = function (event) {
                console.log('WebSocket收到消息：%c' + event.data, 'color:green');
                //获取服务端消息
                var message = JSON.parse(event.data) || {};
                var $messageContainer = $('.message-container');
                //喉咙发炎
                if (message.type === 'SPEAK') {
                    $messageContainer.append(
                        '<div class="mdui-card" style="margin: 10px 0;">' +
                        '<div class="mdui-card-primary">' +
                        '<div class="mdui-card-content message-content">' + message.username + "：" + message
                        .msg + '</div>' +
                        '</div></div>');
                }
                $('.chat-num').text(message.onlineCount);
                //防止刷屏
                var $cards = $messageContainer.children('.mdui-card:visible').toArray();
                if ($cards.length > 5) {
                    $cards.forEach(function (item, index) {
                        index < $cards.length - 5 && $(item).slideUp('fast');
                    });
                }
            };

            /**
             * 关闭连接
             */
            webSocket.onclose = function (event) {
                console.log('WebSocket关闭连接');
            };

            /**
             * 通信失败
             */
            webSocket.onerror = function (event) {
                console.log('WebSocket发生异常');

            };
            return webSocket;
        }

        var webSocket = getWebSocket();

        function closeWebSocket() {
            webSocket.close();
        }

        /**
         * 通过WebSocket对象发送消息给服务端
         */
        function sendMsgToServer() {
            console.log(chatmain.serviceId)
            webSocket.send(JSON.stringify({
                    jsonStr: $("#sendText").val()
            }));
            $("#sendText").val(null)

        }
    </script>

</body>

</html>